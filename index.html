<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Program Șofer</title>

  <!-- PWA -->
  <link rel="manifest" href="/truck-app/manifest.json">
  <meta name="theme-color" content="#0EA5E9" />
  <link rel="icon" href="/truck-app/icons/icon-192.png">

  <style>
    :root{
      --bg:#ffffff; --fg:#0b1220; --muted:#667085; --ring:#0ea5e9;
      --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --barbg:#eef2f7;
      --shadow: 0 1px 2px rgba(0,0,0,.04);
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0; background:var(--bg); color:var(--fg);
      font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji","Segoe UI Emoji";
      padding-bottom: 92px; /* spațiu pt. meniul principal jos */
    }
    .wrap{ max-width:1100px; margin:0 auto; padding:24px; }
    .card{ background:#fff; border:1px solid #e5e7eb; border-radius:16px; padding:20px; box-shadow: var(--shadow); }
    .row{ display:flex; gap:24px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    .left{ display:flex; align-items:center; gap:16px; }
    .gauge{ position:relative; width:180px; height:180px; }
    .center{ position:absolute; inset:0; display:grid; place-items:center; text-align:center; }
    .label{ font-size:11px; text-transform:uppercase; letter-spacing:.06em; color:var(--muted); }
    .big{ font-size:40px; font-weight:600; }
    .right h2{ margin:0 0 6px 0; font-size:13px; color:#374151; }
    .remain{ font-size:32px; font-weight:600; }
    ul.bars{ list-style:none; padding:0; margin:12px 0 0 0; display:flex; flex-direction:column; gap:10px; }
    .barrow{ display:grid; grid-template-columns:auto 1fr auto; gap:10px; align-items:center; }
    .barbg{ height:8px; background:var(--barbg); border-radius:999px; overflow:hidden; }
    .barfg{ height:8px; border-radius:999px; }
    .legend{ margin-top:12px; font-size:12px; color:var(--muted); display:flex; align-items:center; gap:8px; flex-wrap:wrap;}
    .swatch{ width:10px; height:10px; border-radius:2px; display:inline-block; }
    .pill{ border-radius:999px; padding:6px 10px; font-size:12px; border:1px solid #e5e7eb; }
    .status{ display:flex; align-items:center; gap:8px; margin-bottom:8px; flex-wrap:wrap; }

    .switch{ display:inline-flex; align-items:center; gap:8px; border:1px solid #e5e7eb; border-radius:999px; padding:6px 10px; }
    .switch input{ appearance:none; width:36px; height:20px; border:1px solid #e5e7eb; border-radius:999px; position:relative; background:#f1f5f9; outline:none; cursor:pointer; }
    .switch input:checked{ background:#0ea5e9; border-color:#0ea5e9; }
    .switch input::after{ content:""; position:absolute; top:2px; left:2px; width:16px; height:16px; background:#fff; border-radius:50%; transition:transform .2s ease; }
    .switch input:checked::after{ transform:translateX(16px); }

    .mono{ font-variant-numeric: tabular-nums; font-feature-settings:"tnum" 1; }
    .muted{ color:var(--muted); }
    .hint{ font-size:12px; color:#334155; background:#f1f5f9; border:1px solid #e5e7eb; padding:6px 8px; border-radius:8px; }

    /* butoane acțiuni din tabul Zilnic */
    .controls{ display:flex; flex-wrap:wrap; gap:8px; margin:0 0 10px; }
    .chip{ display:flex; align-items:center; gap:6px; padding:8px 10px; border:1px solid #e5e7eb; border-radius:12px; background:#f8fafc; cursor:pointer; }
    .chip:disabled{ opacity:.5; cursor:default; }

    /* Meniul principal jos (taburi) */
    .mobile-nav{
      position:fixed; left:0; right:0; bottom:0;
      background:#fff; border-top:1px solid #e5e7eb; box-shadow: var(--shadow);
      padding:8px max(8px, env(safe-area-inset-right)) calc(8px + env(safe-area-inset-bottom)) max(8px, env(safe-area-inset-left));
      z-index:999;
    }
    .mobile-actions{ display:grid; grid-template-columns:repeat(3,1fr); gap:8px; max-width:1100px; margin:0 auto; }
    .action{
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      gap:6px; padding:10px; border:1px solid #e5e7eb; border-radius:12px; background:#f8fafc; cursor:pointer;
    }
    .action svg{ width:22px; height:22px; }
    .action[aria-selected="true"]{ background:#111827; color:#fff; border-color:#111827; }

    /* --- Weekly cards --- */
    .week-grid { display:grid; gap:12px; grid-template-columns:repeat(auto-fill, minmax(170px, 1fr)); }
    .day-card { background:#fff; border:1px solid #e5e7eb; border-radius:14px; padding:12px; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
    .day-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; }
    .day-badge { width:28px; height:28px; border-radius:999px; display:grid; place-items:center; background:#f1f5f9; color:#0f172a; font-weight:600; font-size:13px; }
    .day-dots { display:flex; gap:6px; align-items:center; }
    .dot-or, .dot-bl { width:8px; height:8px; border-radius:999px; }
    .dot-or{ background:#f59e0b; } /* extins */
    .dot-bl{ background:#38bdf8; } /* pauze ok */
    .row-metric { display:grid; grid-template-columns:auto 1fr auto; gap:8px; align-items:center; }
    .row-metric svg { width:20px; height:20px; }
    .metric-val { font-size:22px; font-weight:600; }
    .metric-sub { font-size:12px; color:#64748b; }
    .week-sum { margin-top:10px; display:flex; gap:12px; flex-wrap:wrap; justify-content:flex-end; align-items:center; font-weight:600; }
    .sum-chip{ display:flex; align-items:center; gap:6px; border:1px solid #e5e7eb; border-radius:10px; padding:6px 10px; background:#f8fafc; }
    .sum-chip svg{ width:18px; height:18px; }
  </style>
</head>
<body>
  <div class="wrap">
    <section class="card" aria-label="Asistență timp condus">
      <header class="status">
        <span class="pill">Stare: <strong id="stateLabel">inactiv</strong></span>
        <span class="pill">Ziua: <span id="dayLabel"></span></span>
        <label class="switch" title="Activează notificări la 4h30 și la limită">
          <input id="toggleAlerts" type="checkbox">
          Alerte
        </label>
        <label class="switch" title="Zi extinsă până la 10h (max 2 ori / 7 zile)">
          <input id="toggleExtended" type="checkbox">
          Zi extinsă 10h
        </label>
        <span id="extLeftBadge" class="pill hint">Extinse rămase: 2</span>
      </header>

      <div class="row">
        <!-- STÂNGA: gauge (condus în SESIUNEA curentă) -->
        <div class="left">
          <div class="gauge" aria-label="Condus în sesiunea curentă">
            <svg id="gaugeSvg" width="180" height="180" viewBox="0 0 180 180" role="img" aria-hidden="true">
              <circle cx="90" cy="90" r="78" fill="none" stroke="#EEF2F7" stroke-width="12"></circle>
              <circle id="gaugeProg" cx="90" cy="90" r="78" fill="none" stroke="#0EA5E9" stroke-width="12"
                      stroke-linecap="round" stroke-dasharray="0 1000" transform="rotate(-90 90 90)"></circle>
              <circle id="marker" cx="90" cy="12" r="4" fill="#F59E0B"></circle>
            </svg>
            <div class="center">
              <div>
                <div class="label">Condus (sesiune)</div>
                <div id="drivenVal" class="big mono">0:00</div>
                <div class="label">Marker 4:30</div>
              </div>
            </div>
          </div>
          <div class="muted" style="max-width:240px">Cercul arată timpul de condus din <strong>sesiunea curentă</strong> (se resetează după pauză ≥ 45′).</div>
        </div>

        <!-- DREAPTA: timp rămas (zilnic) + bare -->
        <div class="right" style="flex:1">
          <div style="display:flex; align-items:baseline; justify-content:space-between;">
            <h2>Timp de condus zilnic rămas</h2>
            <div id="remainVal" class="remain mono">0:00</div>
          </div>

          <ul class="bars">
            <li class="barrow">
              <span class="muted">Condus (sesiune)</span>
              <div class="barbg"><div id="barDriveSess" class="barfg"></div></div>
              <div><span id="barDriveSessVal" class="mono">0:00</span></div>
            </li>
            <li class="barrow">
              <span class="muted">Condus azi</span>
              <div class="barbg"><div id="barDriveDay" class="barfg"></div></div>
              <div><span id="barDriveDayVal" class="mono">0:00</span></div>
            </li>
            <li class="barrow">
              <span class="muted">Pauze</span>
              <div class="barbg"><div id="barBreak" class="barfg"></div></div>
              <div><span id="barBreakVal" class="mono">0:00</span></div>
            </li>
            <li class="barrow">
              <span class="muted">Muncă total</span>
              <div class="barbg"><div id="barWork" class="barfg"></div></div>
              <div><span id="barWorkVal" class="mono">0:00</span></div>
            </li>
            <li class="barrow">
              <span class="muted">Săptămână</span>
              <div class="barbg"><div id="barW1" class="barfg"></div></div>
              <div><span id="barW1Val" class="mono">0:00</span></div>
            </li>
            <li class="barrow">
              <span class="muted">2 săptămâni</span>
              <div class="barbg"><div id="barW2" class="barfg"></div></div>
              <div><span id="barW2Val" class="mono">0:00</span></div>
            </li>
          </ul>

          <div class="legend">
            <span class="swatch" style="background:#0EA5E9"></span> Cerc = Condus (sesiune)
            <span class="swatch" style="background:#F59E0B"></span> Marker 4h30
          </div>
        </div>
      </div>

      <!-- PANOURI -->
      <div id="tab-daily" class="tabpanel active" role="tabpanel" aria-labelledby="Zilnic">
        <!-- bara secundară cu acțiuni -->
        <div class="controls">
          <button id="btnStartDrive" class="chip" title="Începe condus">🚚 Condus</button>
          <button id="btnBreak" class="chip" title="Pauză">☕ Pauză</button>
          <button id="btnWork" class="chip" title="Muncă">🧰 Muncă</button>
          <button id="btnStop" class="chip" title="Termină">⏹️ Termină</button>
        </div>
        <p class="muted">Afișează indicatorii pentru ziua curentă. Cercul = timp de condus în <strong>sesiunea curentă</strong>.</p>
      </div>

      <div id="tab-weekly" class="tabpanel" role="tabpanel" aria-labelledby="Săptămânal">
        <div class="week-grid" id="weekGrid"></div>
        <div class="week-sum">
          <span class="sum-chip" title="Total condus ultimele 7 zile">
            <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M7 2v2H5a2 2 0 0 0-2 2v2h18V6a2 2 0 0 0-2-2h-2V2h-2v2H9V2H7Zm14 8H3v8a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-8Z"/></svg>
            <span><span id="sum7" class="mono">0:00</span> / 56:00</span>
          </span>
          <span class="sum-chip" title="Total condus ultimele 14 zile">
            <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M5 2h2v2h2V2h2v2h2V2h2v2h2a2 2 0 0 1 2 2v2H3V6a2 2 0 0 1 2-2h0V2Z M3 10h18v8a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-8Z"/></svg>
            <span><span id="sum14" class="mono">0:00</span> / 90:00</span>
          </span>
        </div>
      </div>

      <div id="tab-details" class="tabpanel" role="tabpanel" aria-labelledby="Detalii">
        <table>
          <thead><tr><th>Ora</th><th>Tip</th><th>Durata</th></tr></thead>
          <tbody id="logTable"></tbody>
        </table>
      </div>
    </section>
  </div>

  <!-- MENIU PRINCIPAL JOS: Zilnic / Săptămână / Detalii -->
  <footer class="mobile-nav" role="tablist" aria-label="Meniu principal">
    <div class="mobile-actions">
      <button class="action" role="tab" aria-selected="true" data-tab="daily"  id="mainTabDaily"  title="Zilnic">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M7 2v2H5a2 2 0 0 0-2 2v2h18V6a2 2 0 0 0-2-2h-2V2h-2v2H9V2H7Zm14 8H3v8a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-8ZM7 14h5v5H7v-5Z"/></svg>
        <span>Zilnic</span>
      </button>
      <button class="action" role="tab" aria-selected="false" data-tab="weekly" id="mainTabWeekly" title="Săptămână">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M7 2v2H5a2 2 0 0 0-2 2v2h18V6a2 2 0 0 0-2-2h-2V2h-2v2H9V2H7Zm14 8H3v8a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-8ZM6 14h12v2H6v-2Z"/></svg>
        <span>Săptămână</span>
      </button>
      <button class="action" role="tab" aria-selected="false" data-tab="details" id="mainTabDetails" title="Detalii">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2a10 10 0 1 0 0 20A10 10 0 0 0 12 2Zm1 15h-2v-6h2v6Zm0-8h-2V7h2v2Z"/></svg>
        <span>Detalii</span>
      </button>
    </div>
  </footer>

  <script>
    // ---------- Utilitare timp ----------
    const H = (h,m=0) => (h*60+m)*60*1000;
    const fmtHM = ms => {
      const totalMin = Math.max(0, Math.round(ms/60000));
      const h = Math.floor(totalMin/60);
      const m = String(totalMin%60).padStart(2,'0');
      return `${h}:${m}`;
    };
    const clamp = (v,min=0,max=1)=>Math.max(min,Math.min(max,v));
    const todayKey = () => new Date().toLocaleDateString('sv-SE'); // YYYY-MM-DD

    // ---------- Limite ----------
    const BASE_LIMITS = {
      dailyDrive9: H(9,0),
      dailyDrive10: H(10,0),
      marker4h30: H(4,30),
      reqBreak:   H(0,45),
      dailyWork:  H(6,0),
      weekDrive:  H(56,0),
      fortDrive:  H(90,0)
    };

    // ---------- State & storage ----------
    const LS_KEY_DAY  = 'ta-day';
    const LS_KEY_LOGS = 'ta-logs';
    const LS_KEY_SETTINGS = 'ta-settings';

    const settings = loadSettings();
    function loadSettings(){
      const s = JSON.parse(localStorage.getItem(LS_KEY_SETTINGS) || 'null') || { alerts: true };
      localStorage.setItem(LS_KEY_SETTINGS, JSON.stringify(s));
      return s;
    }
    function saveSettings(){ localStorage.setItem(LS_KEY_SETTINGS, JSON.stringify(settings)); }

    function blankDay(day){
      return {
        day,
        current: null, // { type:'drive'|'break'|'work', startAt:number }
        totals: { drive:0, break:0, work:0 },
        events: [], // { type, start, end }
        sessionDriveMs: 0,   // „de la ultima pauză ≥45′”
        extended: false,     // zi extinsă 10h
        notifyFlags: { session45:false, dailyMax:false }
      };
    }

    function archiveDay(dayObj){
      if (dayObj.current){
        const now = Date.now();
        const {type, startAt} = dayObj.current;
        const delta = Math.max(0, now - startAt);
        dayObj.events.push({type, start:startAt, end:now});
        dayObj.totals[type] += delta;
        if (type==='drive') dayObj.sessionDriveMs += delta;
        dayObj.current = null;
      }
      const logs = JSON.parse(localStorage.getItem(LS_KEY_LOGS) || '[]');
      const withoutSame = logs.filter(x => x.day !== dayObj.day);
      withoutSame.push({ day: dayObj.day, totals: dayObj.totals, events: dayObj.events, extended: !!dayObj.extended });
      withoutSame.sort((a,b)=>a.day.localeCompare(b.day));
      const trimmed = withoutSame.slice(-30);
      localStorage.setItem(LS_KEY_LOGS, JSON.stringify(trimmed));
    }

    function loadState(){
      const saved = JSON.parse(localStorage.getItem(LS_KEY_DAY) || 'null');
      const day = todayKey();
      if (!saved || saved.day !== day){
        if (saved) archiveDay(saved);
        const fresh = blankDay(day);
        localStorage.setItem(LS_KEY_DAY, JSON.stringify(fresh));
        return fresh;
      }
      return saved;
    }
    let state = loadState();
    function saveState(){ localStorage.setItem(LS_KEY_DAY, JSON.stringify(state)); }

    // ---------- Helpers: limite curente & extinderi ----------
    function extendedUsedLast7(){
      const logs = JSON.parse(localStorage.getItem(LS_KEY_LOGS) || '[]');
      const last7 = logs.slice(-7);
      return last7.filter(d => d.extended).length + (state.extended ? 1 : 0);
    }
    function extendedLeft(){ return Math.max(0, 2 - extendedUsedLast7()); }
    function currentDailyLimit(){ return state.extended ? BASE_LIMITS.dailyDrive10 : BASE_LIMITS.dailyDrive9; }

    // ---------- Notificări ----------
    async function ensurePermission(){
      if (!settings.alerts) return false;
      if (!('Notification' in window)) return false;
      if (Notification.permission === 'granted') return true;
      if (Notification.permission === 'denied') return false;
      const res = await Notification.requestPermission();
      return res === 'granted';
    }
    function beep(){
      try{
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator(); const g = ctx.createGain();
        o.type = 'sine'; o.frequency.value = 880; g.gain.value = 0.0001;
        o.connect(g); g.connect(ctx.destination);
        o.start();
        const now = ctx.currentTime;
        g.gain.exponentialRampToValueAtTime(0.2, now + 0.02);
        g.gain.exponentialRampToValueAtTime(0.0001, now + 0.6);
        o.stop(now + 0.65);
      }catch(e){}
    }
    async function notify(title, body){
      if (!settings.alerts) return;
      beep(); if (navigator.vibrate) navigator.vibrate(300);
      if (await ensurePermission()){
        try { new Notification(title, { body, icon: '/truck-app/icons/icon-192.png' }); } catch(e){}
      }
      const old = document.title; document.title = `🔔 ${title}`; setTimeout(()=>document.title = old, 2500);
    }

    // ---------- Mașină de stări ----------
    function start(type){
      stopCurrent();
      state.current = { type, startAt: Date.now() };
      saveState(); render();
    }
    function stopCurrent(){
      if (!state.current) return;
      const now = Date.now();
      const { type, startAt } = state.current;
      const delta = Math.max(0, now - startAt);
      state.totals[type] += delta;
      if (type === 'drive') state.sessionDriveMs += delta;
      if (type === 'break' && delta >= BASE_LIMITS.reqBreak){
        state.sessionDriveMs = 0;               // reset sesiune după pauză ≥45′
        state.notifyFlags.session45 = false;    // permitem alerta din nou
      }
      state.events.push({ type, start:startAt, end:now });
      state.current = null;
      saveState();
    }

    // ---------- Elemente UI ----------
    const el = {
      stateLabel: document.getElementById('stateLabel'),
      dayLabel:   document.getElementById('dayLabel'),
      drivenVal:  document.getElementById('drivenVal'),
      remainVal:  document.getElementById('remainVal'),
      gaugeProg:  document.getElementById('gaugeProg'),
      marker:     document.getElementById('marker'),
      bars: {
        driveSess: document.getElementById('barDriveSess'),
        driveDay:  document.getElementById('barDriveDay'),
        break:     document.getElementById('barBreak'),
        work:      document.getElementById('barWork'),
        w1:        document.getElementById('barW1'),
        w2:        document.getElementById('barW2')
      },
      barVals: {
        driveSess: document.getElementById('barDriveSessVal'),
        driveDay:  document.getElementById('barDriveDayVal'),
        break:     document.getElementById('barBreakVal'),
        work:      document.getElementById('barWorkVal'),
        w1:        document.getElementById('barW1Val'),
        w2:        document.getElementById('barW2Val')
      },
      weekGrid: document.getElementById('weekGrid'),
      logTable: document.getElementById('logTable'),
      switches: {
        alerts: document.getElementById('toggleAlerts'),
        extended: document.getElementById('toggleExtended'),
        extLeft: document.getElementById('extLeftBadge')
      },
      mainTabs: {
        daily:  document.getElementById('mainTabDaily'),
        weekly: document.getElementById('mainTabWeekly'),
        details:document.getElementById('mainTabDetails')
      },
      panels: {
        daily:  document.getElementById('tab-daily'),
        weekly: document.getElementById('tab-weekly'),
        details:document.getElementById('tab-details')
      },
      actionBtns: {
        drive: document.getElementById('btnStartDrive'),
        break: document.getElementById('btnBreak'),
        work:  document.getElementById('btnWork'),
        stop:  document.getElementById('btnStop')
      }
    };

    function colorByRatio(r){ return r<.8 ? 'var(--ok)' : (r<1 ? 'var(--warn)' : 'var(--bad)'); }
    function setBar(elBar, valueMs, targetMs){
      const ratio = clamp(targetMs ? valueMs/targetMs : 0);
      elBar.style.width = (ratio*100)+'%';
      elBar.style.background = colorByRatio(ratio);
    }
    function getLogs(){ return JSON.parse(localStorage.getItem(LS_KEY_LOGS) || '[]'); }
    function calcTotalsWithCurrent(){
      const now = Date.now();
      const t = {...state.totals};
      if (state.current){
        const d = Math.max(0, now - state.current.startAt);
        t[state.current.type] += d;
      }
      return t;
    }
    function sumWindows(){
      const logs = getLogs();
      const days = [...logs, {day: state.day, totals: {...state.totals}}];
      const nowDriveExtra = state.current && state.current.type==='drive' ? (Date.now()-state.current.startAt) : 0;
      days[days.length-1].totals.drive += nowDriveExtra;
      const lastN = (n) => days.slice(-n).reduce((acc,d)=>acc + (d.totals?.drive||0), 0);
      return { weekDrive: lastN(7), fortDrive: lastN(14) };
    }

    function updateButtons(){
      const t = state.current?.type;
      el.actionBtns.drive.disabled = t === 'drive';
      el.actionBtns.break.disabled = t === 'break';
      el.actionBtns.work.disabled  = t === 'work';
      el.actionBtns.stop.disabled  = !t;
    }

    function renderWeeklyCards(){
      const logs = getLogs();
      const days = [...logs, { day: state.day, totals: calcTotalsWithCurrent(), extended: state.extended }].slice(-7);
      el.weekGrid.innerHTML = days.map((d, idx) => {
        const t = d.totals || { drive:0, work:0, break:0 };
        const hasLongBreak = (t.break||0) >= BASE_LIMITS.reqBreak;
        const isExtended   = !!d.extended;
        return `
          <div class="day-card">
            <div class="day-header">
              <div class="day-badge">${idx+1}</div>
              <div class="day-dots">
                ${isExtended ? '<span class="dot-or" title="Zi extinsă 10h"></span>' : ''}
                ${hasLongBreak ? '<span class="dot-bl" title="Pauze ≥ 45 min"></span>' : ''}
              </div>
            </div>
            <div class="row-metric" title="Condus (total zi)">
              <svg viewBox="0 0 24 24"><path d="M12 2a10 10 0 1 0 0 20A10 10 0 0 0 12 2Zm0 2a8 8 0 0 1 7.75 6H4.25A8 8 0 0 1 12 4Zm-8 8h6a2 2 0 0 0 2-2h4a6 6 0 0 1-6 6H4a2 2 0 0 1-2-2Zm20 0a2 2 0 0 1-2 2h-4a6 6 0 0 1-6-6h4a2 2 0 0 0 2 2h6Z"/></svg>
              <span class="metric-sub">Condus</span>
              <span class="metric-val mono">${fmtHM(t.drive||0)}</span>
            </div>
            <div class="row-metric" title="Muncă total (zi)">
              <svg viewBox="0 0 24 24"><path d="M4 3h2v18H4V3Zm3 2h9l-1.5 3L16 11H7V5Z"/></svg>
              <span class="metric-sub">Muncă</span>
              <span class="metric-val mono">${fmtHM(t.work||0)}</span>
            </div>
          </div>`;
      }).join('');

      const {weekDrive, fortDrive} = sumWindows();
      document.getElementById('sum7').textContent  = fmtHM(weekDrive);
      document.getElementById('sum14').textContent = fmtHM(fortDrive);
    }

    async function checkAlerts(driveSess, driveDay, limitDay){
      if (!state.notifyFlags.session45 && driveSess >= BASE_LIMITS.marker4h30){
        state.notifyFlags.session45 = true; saveState();
        await notify('Pauză necesară', 'Ai atins 4h30 de condus în sesiunea curentă.');
      }
      if (!state.notifyFlags.dailyMax && driveDay >= limitDay){
        state.notifyFlags.dailyMax = true; saveState();
        await notify('Limită zilnică atinsă', `Ai ajuns la ${limitDay===BASE_LIMITS.dailyDrive10?'10h':'9h'} de condus astăzi.`);
      }
    }

    function render(){
      // rollover zi
      const day = todayKey();
      if (day !== state.day){ archiveDay(state); state = blankDay(day); saveState(); }

      // header
      el.stateLabel.textContent = state.current ? state.current.type : 'inactiv';
      el.dayLabel.textContent = state.day;

      // setări UI
      el.switches.alerts.checked = !!settings.alerts;
      el.switches.extended.checked = !!state.extended;
      const left = extendedLeft();
      el.switches.extLeft.textContent = `Extinse rămase: ${left}`;
      el.switches.extended.disabled = left === 0 && !state.extended;

      // totaluri curente + sesiune curentă
      const now = Date.now();
      const t = calcTotalsWithCurrent();
      let driveSess = state.sessionDriveMs;
      if (state.current?.type === 'drive'){ driveSess += Math.max(0, now - state.current.startAt); }

      const driveDay = t.drive;
      const dayLimit = currentDailyLimit();
      const remain = Math.max(0, dayLimit - driveDay);

      // valori UI
      el.drivenVal.textContent = fmtHM(driveSess);
      el.remainVal.textContent = fmtHM(remain);

      // cerc (raport la 4h30)
      const r = 78, c = 2*Math.PI*r, p = clamp(driveSess / BASE_LIMITS.marker4h30);
      el.gaugeProg.setAttribute('stroke-dasharray', `${c*p} ${c*(1-p)}`);
      const angle = 2*Math.PI*1 - Math.PI/2; // marker 4:30 jos
      const x = 90 + r*Math.cos(angle), y = 90 + r*Math.sin(angle);
      el.marker.setAttribute('cx', x.toFixed(2)); el.marker.setAttribute('cy', y.toFixed(2));

      // bare
      setBar(el.bars.driveSess, driveSess, BASE_LIMITS.marker4h30);
      setBar(el.bars.driveDay,  driveDay,  dayLimit);
      setBar(el.bars.break,     t.break,   BASE_LIMITS.reqBreak);
      setBar(el.bars.work,      t.work,    BASE_LIMITS.dailyWork);

      const {weekDrive, fortDrive} = sumWindows();
      setBar(el.bars.w1, weekDrive, BASE_LIMITS.weekDrive);
      setBar(el.bars.w2, fortDrive, BASE_LIMITS.fortDrive);

      // tabele/panouri
      renderWeeklyCards();
      renderLog();

      // stări butoane
      updateButtons();

      // alerte
      checkAlerts(driveSess, driveDay, dayLimit);
    }

    function renderLog(){
      const list = [...state.events];
      if (state.current){ list.push({ type: state.current.type, start: state.current.startAt, end: Date.now() }); }
      document.getElementById('logTable').innerHTML = list.map(e=>{
        const dur = Math.max(0, (e.end||Date.now()) - e.start);
        const hhmm = fmtHM(dur);
        const start = new Date(e.start).toLocaleTimeString('ro-RO',{hour:'2-digit',minute:'2-digit'});
        return `<tr><td>${start}</td><td>${e.type}</td><td class="mono">${hhmm}</td></tr>`;
      }).join('');
    }

    // ---------- Tab-uri (meniu principal jos) ----------
    const mainTabs = document.querySelectorAll('.mobile-nav .action[role="tab"]');
    function selectMainTab(key){
      mainTabs.forEach(b => b.setAttribute('aria-selected', b.dataset.tab === key ? 'true' : 'false'));
      Object.entries(el.panels).forEach(([k,p]) => { if (k===key) p.classList.add('active'); else p.classList.remove('active'); });
    }
    mainTabs.forEach(btn => btn.addEventListener('click', ()=> selectMainTab(btn.dataset.tab)));
    selectMainTab('daily');

    // ---------- Handlers butoane & switch-uri ----------
    el.actionBtns.drive.onclick = ()=> start('drive');
    el.actionBtns.break.onclick = ()=> start('break');
    el.actionBtns.work.onclick  = ()=> start('work');
    el.actionBtns.stop.onclick  = ()=>{
      if (!state.current) return;
      if (confirm('Termini sesiunea curentă?')) { stopCurrent(); render(); }
    };

    el.switches.alerts.addEventListener('change', async (e)=>{
      settings.alerts = e.target.checked; saveSettings(); if (settings.alerts) await ensurePermission();
    });
    el.switches.extended.addEventListener('change', (e)=>{
      const want = e.target.checked;
      if (want){
        if (extendedLeft() === 0){
          alert('Ai folosit deja 2 zile extinse în ultimele 7 zile.');
          e.target.checked = false; return;
        }
        state.extended = true;
      } else { state.extended = false; }
      state.notifyFlags.dailyMax = false;
      saveState(); render();
    });

    // ---------- Tick & init ----------
    setInterval(render, 1000);
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/truck-app/sw.js', { scope: '/truck-app/' }).catch(console.error);
      });
    }
    document.addEventListener('visibilitychange', ()=>{
      const day = todayKey();
      if (day !== state.day){ archiveDay(state); state = blankDay(day); saveState(); }
      render();
    });
    (async ()=>{ if (settings.alerts) await ensurePermission(); render(); })();
  </script>
</body>
</html>